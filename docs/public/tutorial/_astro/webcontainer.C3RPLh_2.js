import{i as tr}from"./is-preview-message.ZaUdCj-5.js";import{a as B}from"./index.DgoachrA.js";import{g as rr}from"./index.DNi1g-pO.js";const sr="https://stackblitz.com",Ie="code",He="error",pt="error_description",nr="__wc_api_bc__",nt="__wc_api_tokens__",Ke="__wc_api_verifier__",Ve="__wc_api_popup__";class ot{_bus=new EventTarget;listen(e){function t(s){e(s.data)}return this._bus.addEventListener("message",t),()=>this._bus.removeEventListener("message",t)}fireEvent(e){this._bus.dispatchEvent(new MessageEvent("message",{data:e}))}}const xt=new Error;xt.stack="";const Pt=new ot;class ue{origin;refresh;access;expires;_revoked=new AbortController;constructor(e,t,s,n){this.origin=e,this.refresh=t,this.access=s,this.expires=n}async activate(e,t){if(this._revoked.signal.aborted)throw new Error("Token revoked");return e&&this.expires<Date.now()&&!await this._fetchNewAccessToken()?!1:(this._sync(),e&&this._startRefreshTokensLoop(t),!0)}async revoke(e,t){this._revoked.abort();try{if(!(await fetch(`${this.origin}/oauth/revoke`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({token:this.refresh,token_type_hint:"refresh_token",client_id:e}),mode:"cors"})).ok)throw new Error("Failed to logout")}catch(s){if(!t)throw s}Je()}static fromStorage(){const e=ir();return e?new ue(e.origin,e.refresh,e.access,e.expires):null}static async fromAuthCode({editorOrigin:e,clientId:t,codeVerifier:s,authCode:n,redirectUri:o}){const i=await fetch(`${e}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:t,code:n,code_verifier:s,grant_type:"authorization_code",redirect_uri:o}),mode:"cors"});if(!i.ok)throw new Error(`Failed to fetch token: ${i.status}`);const a=await i.json();_t(a);const{access_token:f,refresh_token:h}=a,p=dt(a);return new ue(e,h,f,p)}async _fetchNewAccessToken(){try{const e=await fetch(`${this.origin}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:this.refresh}),mode:"cors",signal:this._revoked.signal});if(!e.ok)throw xt;const t=await e.json();_t(t);const{access_token:s,refresh_token:n}=t,o=dt(t);return this.access=s,this.expires=o,this.refresh=n,!0}catch{return Je(),!1}}_sync(){ar(this),ur(this.access)}async _startRefreshTokensLoop(e){for(;;){const t=this.expires-Date.now()-1e3;if(await cr(Math.max(t,1e3)),this._revoked.signal.aborted)return;if(!this._fetchNewAccessToken()){e();return}this._sync()}}}function Je(){localStorage.removeItem(nt)}function or(r){return Pt.listen(r)}function ir(){const r=localStorage.getItem(nt);if(!r)return null;try{return JSON.parse(r)}catch{return null}}function ar(r){localStorage.setItem(nt,JSON.stringify(r))}function dt({created_at:r,expires_in:e}){return(r+e)*1e3}function _t(r){if(typeof r!="object"||!r)throw new Error("Invalid Token Response");if(typeof r.access_token!="string"||typeof r.refresh_token!="string"||typeof r.created_at!="number"||typeof r.expires_in!="number")throw new Error("Invalid Token Response")}function cr(r){return new Promise(e=>setTimeout(e,r))}function ur(r){Pt.fireEvent(r)}const De={};let ye=null;const ke={get editorOrigin(){return ye==null&&(ye=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??sr).origin),ye},set editorOrigin(r){ye=new URL(r).origin},setQueryParam(r,e){De[r]=e},get url(){const r=new URL(this.editorOrigin);r.pathname="/headless";for(const e in De)r.searchParams.set(e,De[e]);return r.searchParams.set("version","1.5.1"),r}};async function lr(r){const e=new TextEncoder().encode(r),t=new Uint8Array(await crypto.subtle.digest("SHA-256",e));return btoa(t.reduce((s,n)=>s+String.fromCodePoint(n),"")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function fr(){const r=new Uint8Array(96);crypto.getRandomValues(r);let e="";for(let t=0;t<32;++t)e+=hr(r[3*t+0],r[3*t+1],r[3*t+2]);return e}function hr(r,e,t){const s=r>>2,n=(r&3)<<4|e>>4,o=e&15|(t&192)>>2,i=t&63;return[s,n,o,i].map(pr).join("")}function pr(r){let e;return r<26?e=r+65:r<52?e=r-26+97:r<62?e=r-52+48:e=r===62?30:45,String.fromCharCode(e)}function dr(){let r,e;function t(){e=new Promise(s=>r=s)}return t(),{get promise(){return e},resolve(s){return r(s)},reset:t}}const w={initialized:!1,bootCalled:!1,forwardAuth:!0,redirectUri:"",authComplete:dr(),clientId:"",oauthScope:"",broadcastChannel:null,get editorOrigin(){return ke.editorOrigin},tokens:null,cleanup:[]},mt=new ot,re=new ot;function he(r){w.broadcastChannel&&(w.broadcastChannel.postMessage(r),localStorage.getItem(Ve)==="true"&&r.type!=="auth-logout"&&(localStorage.removeItem(Ve),setTimeout(()=>{window.close()})))}const _r={init({editorOrigin:r,clientId:e,scope:t,forwardAuth:s,redirectUri:n}){if(w.initialized)throw new Error("Init should only be called once");if(w.bootCalled)throw new Error("`auth.init` should always be called before `WebContainer.boot`");w.initialized=!0,w.forwardAuth=s??!0,w.redirectUri=n??qe();let o=!0;w.tokens=ue.fromStorage(),w.clientId=e,w.oauthScope=t,w.broadcastChannel=new BroadcastChannel(nr),ke.setQueryParam("client_id",e),r&&(ke.editorOrigin=new URL(r).origin),re.listen(()=>w.authComplete.reset()),w.broadcastChannel.addEventListener("message",i);async function i(p){const m=p.data;if(m.type==="auth-complete"){if(w.tokens=ue.fromStorage(),!w.tokens&&!o){console.error("@webcontainer/api: Bug found: tokens were no longer present in storage!");return}await w.tokens.activate(o,Ne),w.authComplete.resolve();return}if(m.type==="auth-failed"){mt.fireEvent(m);return}if(m.type==="auth-logout"){re.fireEvent();return}}if(w.tokens){const p=w.tokens;if(p.origin===w.editorOrigin)return(async()=>{if(!await p.activate(o,Ne)){if(w.tokens!==p)return;re.fireEvent();return}w.authComplete.resolve()})(),{status:"authorized"};Je(),w.tokens=null}const a=new URL(window.location.href),{searchParams:f}=a,h=()=>window.history.replaceState({},document.title,a);if(f.has(He)){const p=f.get(He),m=f.get(pt);return f.delete(He),f.delete(pt),h(),he({type:"auth-failed",error:p,description:m}),{status:"auth-failed",error:p,description:m}}if(f.has(Ie)){const p=f.get(Ie),m=w.editorOrigin;f.delete(Ie),h();const S=localStorage.getItem(Ke);if(!S)return{status:"need-auth"};localStorage.removeItem(Ke);let T=qe();return ue.fromAuthCode({editorOrigin:m,clientId:w.clientId,authCode:p,codeVerifier:S,redirectUri:T}).then(async A=>{if(w.tokens=A,Ot(w.tokens),!await w.tokens.activate(o,Ne))throw new Error;w.authComplete.resolve(),he({type:"auth-complete"})}).catch(A=>{console.error(A),re.fireEvent(),he({type:"auth-logout"})}),{status:"authorized"}}return{status:"need-auth"}},async startAuthFlow({popup:r}={}){if(!w.initialized)throw new Error("auth.init must be called first");if(r){localStorage.setItem(Ve,"true");const e=500,t=620,s=window.screenLeft+(window.outerWidth-t)/2,n=window.screenTop+(window.outerHeight-e)/2;window.open(await wt(),"_blank",`popup,width=${t},height=${e},left=${s},top=${n}`)}else window.location.href=await wt()},async logout({ignoreRevokeError:r}={}){await w.tokens?.revoke(w.clientId,r??!1),re.fireEvent(),he({type:"auth-logout"})},loggedIn(){return w.authComplete.promise},on(r,e){switch(r){case"auth-failed":return mt.listen(e);case"logged-out":return re.listen(e);default:throw new Error(`Unsupported event type '${r}'.`)}}};function Ne(){re.fireEvent(),he({type:"auth-logout"})}function qe(){return window.location.href}async function wt(){const r=fr();localStorage.setItem(Ke,r);const e=await lr(r),t=new URL("/oauth/authorize",w.editorOrigin),{searchParams:s}=t;let n=qe();return s.append("response_type","code"),s.append("client_id",w.clientId),s.append("redirect_uri",n),s.append("scope",w.oauthScope),s.append("code_challenge",e),s.append("code_challenge_method","S256"),t.toString()}function Ot(r){if(!r)throw new Error("Oops! Tokens is not defined when it always should be.")}var mr=Object.defineProperty,wr=(r,e)=>{for(var t in e)mr(r,t,{get:e[t],enumerable:!0})},V={};wr(V,{createEndpoint:()=>Ft,expose:()=>ct,proxy:()=>Wt,proxyMarker:()=>it,releaseProxy:()=>$t,transfer:()=>Mt,transferHandlers:()=>at,windowEndpoint:()=>Sr,wrap:()=>Dt});var it=Symbol("Comlink.proxy"),Ft=Symbol("Comlink.endpoint"),$t=Symbol("Comlink.releaseProxy"),Qe=Symbol("Comlink.thrown"),It=r=>typeof r=="object"&&r!==null||typeof r=="function",gr={canHandle:r=>It(r)&&r[it],serialize(r){const{port1:e,port2:t}=new MessageChannel;return ct(r,e),[t,[t]]},deserialize(r){return r.start(),Dt(r)}},yr={canHandle:r=>It(r)&&Qe in r,serialize({value:r}){let e;return r instanceof Error?e={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:e={isError:!1,value:r},[e,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},at=new Map([["proxy",gr],["throw",yr]]);function ct(r,e=self){e.addEventListener("message",function t(s){if(!s||!s.data)return;const{id:n,type:o,path:i}=Object.assign({path:[]},s.data),a=(s.data.argumentList||[]).map(se);let f;try{const h=i.slice(0,-1).reduce((m,S)=>m[S],r),p=i.reduce((m,S)=>m[S],r);switch(o){case 0:f=p;break;case 1:h[i.slice(-1)[0]]=se(s.data.value),f=!0;break;case 2:f=p.apply(h,a);break;case 3:{const m=new p(...a);f=Wt(m)}break;case 4:{const{port1:m,port2:S}=new MessageChannel;ct(r,S),f=Mt(m,[m])}break;case 5:f=void 0;break}}catch(h){f={value:h,[Qe]:0}}Promise.resolve(f).catch(h=>({value:h,[Qe]:0})).then(h=>{const[p,m]=ut(h);e.postMessage(Object.assign(Object.assign({},p),{id:n}),m),o===5&&(e.removeEventListener("message",t),Ht(e))})}),e.start&&e.start()}function br(r){return r.constructor.name==="MessagePort"}function Ht(r){br(r)&&r.close()}function Dt(r,e){return Ye(r,[],e)}function be(r){if(r)throw new Error("Proxy has been released and is not useable")}function Ye(r,e=[],t=function(){}){let s=!1;const n=new Proxy(t,{get(o,i){if(be(s),i===$t)return()=>ie(r,{type:5,path:e.map(a=>a.toString())}).then(()=>{Ht(r),s=!0});if(i==="then"){if(e.length===0)return{then:()=>n};const a=ie(r,{type:0,path:e.map(f=>f.toString())}).then(se);return a.then.bind(a)}return Ye(r,[...e,i])},set(o,i,a){be(s);const[f,h]=ut(a);return ie(r,{type:1,path:[...e,i].map(p=>p.toString()),value:f},h).then(se)},apply(o,i,a){be(s);const f=e[e.length-1];if(f===Ft)return ie(r,{type:4}).then(se);if(f==="bind")return Ye(r,e.slice(0,-1));const[h,p]=gt(a);return ie(r,{type:2,path:e.map(m=>m.toString()),argumentList:h},p).then(se)},construct(o,i){be(s);const[a,f]=gt(i);return ie(r,{type:3,path:e.map(h=>h.toString()),argumentList:a},f).then(se)}});return n}function Cr(r){return Array.prototype.concat.apply([],r)}function gt(r){const e=r.map(ut);return[e.map(t=>t[0]),Cr(e.map(t=>t[1]))]}var Nt=new WeakMap;function Mt(r,e){return Nt.set(r,e),r}function Wt(r){return Object.assign(r,{[it]:!0})}function Sr(r,e=self,t="*"){return{postMessage:(s,n)=>r.postMessage(s,t,n),addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e)}}function ut(r){for(const[e,t]of at)if(t.canHandle(r)){const[s,n]=t.serialize(r);return[{type:3,name:e,value:s},n]}return[{type:0,value:r},Nt.get(r)||[]]}function se(r){switch(r.type){case 3:return at.get(r.name).deserialize(r.value);case 0:return r.value}}function ie(r,e,t){return new Promise(s=>{const n=Ar();r.addEventListener("message",function o(i){!i.data||!i.data.id||i.data.id!==n||(r.removeEventListener("message",o),s(i.data))}),r.start&&r.start(),r.postMessage(Object.assign({id:n},e),t)})}function Ar(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function ae(r){const e=Object.create(null);return r?Object.assign(e,r):e}function Ut(r){const e={d:{}};for(const t of Object.keys(r)){const s=r[t];if("file"in s){if("symlink"in s.file){e.d[t]={f:{l:s.file.symlink}};continue}const o=s.file.contents,i=typeof o=="string"?o:Er(o),a=typeof o=="string"?{}:{b:!0};e.d[t]={f:{c:i,...a}};continue}const n=Ut(s.directory);e.d[t]=n}return e}function Bt(r){const e=ae();if("f"in r)throw new Error("It is not possible to export a single file in the JSON format.");if("d"in r)for(const t of Object.keys(r.d)){const s=r.d[t];"d"in s?e[t]=ae({directory:Bt(s)}):"f"in s&&("c"in s.f?e[t]=ae({file:ae({contents:s.f.c})}):"l"in s.f&&(e[t]=ae({file:ae({symlink:s.f.l})})))}return e}function Er(r){let e="";for(const t of r)e+=String.fromCharCode(t);return e}const de=_r;let Ce=null,Se=null,Me={};const Gt=new TextDecoder,Rr=new TextEncoder;class oe{_instance;_runtimeInfo;fs;static _instance=null;_tornDown=!1;_unsubscribeFromTokenChangedListener=()=>{};constructor(e,t,s){this._instance=e,this._runtimeInfo=s,this.fs=new Pr(t),w.initialized&&!0&&(this._unsubscribeFromTokenChangedListener=or(o=>{this._instance.setCredentials({accessToken:o,editorOrigin:w.editorOrigin})}),(async()=>{await w.authComplete.promise,!this._tornDown&&(Ot(w.tokens),await this._instance.setCredentials({accessToken:w.tokens.access,editorOrigin:w.editorOrigin}))})().catch(o=>{console.error(o)}))}async spawn(e,t,s){let n=[];Array.isArray(t)?n=t:s=t;let o,i=new ReadableStream;if(s?.output!==!1){const x=Hr();o=x.push,i=x.stream}let a,f,h,p;const m=ve(We(o)),S=ve(We(a)),T=ve(We(h)),A=await this._instance.run({command:e,args:n,cwd:s?.cwd,env:s?.env,terminal:s?.terminal},S,T,m);return new xr(A,i,f,p)}async export(e,t){const s={format:t?.format??"json",includes:t?.includes,excludes:t?.excludes,external:!0},n=await this._instance.serialize(e,s);if(s.format==="json"){const o=JSON.parse(Gt.decode(n));return Bt(o)}return n}on(e,t){if(e==="preview-message"){const o=t;t=i=>{tr(i)&&o(i)}}const{listener:s,subscribe:n}=Dr(t);return n(this._instance.on(e,V.proxy(s)))}mount(e,t){const s=e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):Rr.encode(JSON.stringify(Ut(e)));return this._instance.loadFiles(V.transfer(s,[s.buffer]),{mountPoints:t?.mountPoint})}setPreviewScript(e,t){return this._instance.setPreviewScript(e,t)}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener(),this.fs._teardown(),this._instance.teardown(),this._instance[V.releaseProxy](),oe._instance===this&&(oe._instance=null)}static async boot(e={}){const{workdirName:t}=e;if(window.crossOriginIsolated&&e.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),t?.includes("/")||t===".."||t===".")throw new Error("workdirName should be a valid folder name");for(w.bootCalled=!0;Ce;)await Ce;if(oe._instance)throw new Error("Only a single WebContainer instance can be booted");const s=Or(e);Ce=s.catch(()=>{});try{const n=await s;return oe._instance=n,n}finally{Ce=null}}}const vr=1,Tr=2;class kr{name;_type;constructor(e,t){this.name=e,this._type=t}isFile(){return this._type===vr}isDirectory(){return this._type===Tr}}class Lr{_apiClient;_path;_options;_listener;_wrappedListener;_watcher;_closed=!1;constructor(e,t,s,n){this._apiClient=e,this._path=t,this._options=s,this._listener=n,this._apiClient._watchers.add(this),this._wrappedListener=(o,i)=>{this._listener&&!this._closed&&this._listener(o,i)},this._apiClient._fs.watch(this._path,this._options,ve(this._wrappedListener)).then(o=>{this._watcher=o,this._closed&&this._teardown()}).catch(console.error)}close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),this._teardown())}_teardown(){this._watcher?.close().finally(()=>{this._watcher?.[V.releaseProxy]()})}}class xr{output;input;exit;_process;stdout;stderr;constructor(e,t,s,n){this.output=t,this._process=e,this.input=new WritableStream({write:o=>{this._getProcess()?.write(o).catch(()=>{})}}),this.exit=this._onExit(),this.stdout=s,this.stderr=n}kill(){this._getProcess()?.kill()}resize(e){this._getProcess()?.resize(e)}async _onExit(){try{return await this._process.onExit}finally{this._process?.[V.releaseProxy](),this._process=null}}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}}class Pr{_fs;_watchers=new Set([]);constructor(e){this._fs=e}rm(...e){return this._fs.rm(...e)}async readFile(e,t){return await this._fs.readFile(e,t)}async rename(e,t){return await this._fs.rename(e,t)}async writeFile(e,t,s){if(t instanceof Uint8Array){const n=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);t=V.transfer(new Uint8Array(n),[n])}await this._fs.writeFile(e,t,s)}async readdir(e,t){const s=await this._fs.readdir(e,t);return $r(s)||Ir(s)?s:s.map(o=>new kr(o.name,o["Symbol(type)"]))}async mkdir(e,t){return await this._fs.mkdir(e,t)}watch(e,t,s){return typeof t=="function"&&(s=t,t=null),new Lr(this,e,t,s)}_teardown(){this._fs[V.releaseProxy]();for(const e of this._watchers)e.close()}}async function Or(r){const{serverPromise:e}=Fr(r),s=await(await e).build({host:window.location.host,version:"1.5.1",workdirName:r.workdirName,forwardPreviewErrors:r.forwardPreviewErrors}),n=await s.fs(),o=await s.runtimeInfo();return new oe(s,n,o)}function We(r){if(r!=null)return e=>{e instanceof Uint8Array?r(Gt.decode(e)):e==null&&r(null)}}function ve(r){if(r!=null)return V.proxy(r)}function Fr(r){if(Se!=null)return r.coep!==Me.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${r.coep}'`),console.warn(`First boot had 'coep: ${Me.coep}', new settings will not take effect!`)),{serverPromise:Se};const e=document.createElement("iframe");e.style.display="none",e.setAttribute("allow","cross-origin-isolated");const t=ke.url;r.coep&&t.searchParams.set("coep",r.coep),e.src=t.toString();const{origin:s}=t;return Me={...r},Se=new Promise(n=>{const o=i=>{if(i.origin!==s)return;const{data:a}=i;if(a.type==="init"){n(V.wrap(i.ports[0]));return}if(a.type==="warning"){console[a.level].call(console,a.message);return}};window.addEventListener("message",o)}),document.body.insertBefore(e,null),{serverPromise:Se}}function $r(r){return typeof r[0]=="string"}function Ir(r){return r[0]instanceof Uint8Array}function Hr(){let r=null;return{stream:new ReadableStream({start(s){r=s}}),push:s=>{s!=null?r?.enqueue(s):(r?.close(),r=null)}}}function Dr(r){let e=!1,t=()=>{};return{subscribe(n){return n.then(o=>{t=o,e&&t()}),()=>{e=!0,t()}},listener:(...n)=>{e||r(...n)}}}const Nr=5,Ae=6,Ee=10;let Mr=(r,e,t,s)=>(r.events=r.events||{},r.events[t+Ee]||(r.events[t+Ee]=s(n=>{r.events[t].reduceRight((o,i)=>(i(o),o),{shared:{},...n})})),r.events[t]=r.events[t]||[],r.events[t].push(e),()=>{let n=r.events[t],o=n.indexOf(e);n.splice(o,1),n.length||(delete r.events[t],r.events[t+Ee](),delete r.events[t+Ee])}),Wr=1e3,Ur=(r,e)=>Mr(r,s=>{let n=e(s);n&&r.events[Ae].push(n)},Nr,s=>{let n=r.listen;r.listen=(...i)=>(!r.lc&&!r.active&&(r.active=!0,s()),n(...i));let o=r.off;return r.events[Ae]=[],r.off=()=>{o(),setTimeout(()=>{if(r.active&&!r.lc){r.active=!1;for(let i of r.events[Ae])i();r.events[Ae]=[]}},Wr)},()=>{r.listen=n,r.off=o}}),Br=(r,e,t)=>{Array.isArray(r)||(r=[r]);let s,n=0,o=()=>{let f=r.map(h=>h.get());if(s===void 0||f.some((h,p)=>h!==s[p])){let h=++n;s=f;let p=e(...f);p&&p.then&&p.t?p.then(m=>{h===n&&i.set(m)}):i.set(p)}},i=B(void 0,Math.max(...r.map(f=>f.l))+1),a=o;return Ur(i,()=>{let f=r.map(h=>h.listen(a,-1/i.l));return o(),()=>{for(let h of f)h()}}),i},yt=(r,e)=>Br(r,e),Gr=(r={})=>{let e=B(r);return e.setKey=function(t,s){let n=e.value;typeof s>"u"&&t in e.value?(e.value={...e.value},delete e.value[t],e.notify(n,t)):e.value[t]!==s&&(e.value={...e.value,[t]:s},e.notify(n,t))},e};const zt=!1;class Ze{prepareCommands;mainCommand;constructor({prepareCommands:e,mainCommand:t}){this.prepareCommands=e?.map(s=>new le(s)),this.mainCommand=t?new le(t):void 0}[Symbol.iterator](){const e=this;return function*(){for(const t of e.prepareCommands??[])yield t;e.mainCommand&&(yield e.mainCommand)}()}}class le{shellCommand;title;constructor(e){this.shellCommand=le.toShellCommand(e),this.title=le.toTitle(e)}isRunnable(){return this.shellCommand!==""}static equals(e,t){return e.shellCommand===t.shellCommand}static toTitle(e){let t="";return typeof e=="string"?t=e:Array.isArray(e)?t=e[1]:t=e.title,t}static toShellCommand(e){return typeof e=="string"?e:Array.isArray(e)?e[0]:e.command}}function jt(){if(typeof Promise.withResolvers=="function")return Promise.withResolvers();let r,e;const t=new Promise((s,n)=>{r=s,e=n});return{resolve:r,reject:e,promise:t}}function zr(r){return new Promise(e=>setTimeout(e,r))}function jr(){return new Promise(r=>{setTimeout(r)})}const ne=B("unknown"),Xt=jt(),Xr=ne;async function Kr(r){ne.get()==="unknown"&&ne.set(Jr()?"blocked":"booting"),ne.get()==="blocked"&&(await Xt.promise,ne.set("booting"));const e=await oe.boot(r);return ne.set("booted"),e}function Vr(){ne.get()==="blocked"&&Xt.resolve()}function Jr(){const{userAgent:r,maxTouchPoints:e,platform:t}=navigator,s=/iPhone/.test(r)||t==="iPhone",n=t==="MacIntel"&&e>1||t==="iPad";return s||n}class bt{port;origin;ready;constructor(e,t,s=!1){this.port=e,this.origin=t,this.ready=s}}class Re{portInfo;title;pathname;get url(){if(this.baseUrl)return new URL(this.pathname??"/",this.baseUrl).toString()}get port(){return this.portInfo.port}get baseUrl(){return this.portInfo.origin}get ready(){return this.portInfo.ready}constructor(e,t){this.title=e.title,this.pathname=e.pathname,this.portInfo=t}static parse(e){if(typeof e=="number")return{port:e};if(typeof e=="string"){const[t,...s]=e.split("/");return{port:parseInt(t),pathname:s.join("/")}}else return Array.isArray(e)?{port:e[0],title:e[1],pathname:e[2]}:e}static equals(e,t){return e.portInfo.port===t.portInfo.port&&e.pathname===t.pathname&&e.title===t.title}}class qr{steps=B(void 0);setFromCommands(e){e.length>0?this.steps.set(e.map(t=>({title:t.title,status:"idle"}))):this.steps.set(void 0)}updateStep(e,t){const s=this.steps.value;s&&this.steps.set([...s.slice(0,e),t,...s.slice(e+1)])}skipRemaining(e){const t=this.steps.value;t&&this.steps.set([...t.slice(0,e),...t.slice(e).map(s=>({...s,status:"skipped"}))])}}const Qr=Symbol("kTaskCancelled");class Ue extends Error{}function q(r,e={}){const t=new AbortController,s=()=>t.abort(new Ue),n=e.signal;let o=r(t.signal);return n&&(o=o.finally(()=>n.removeEventListener("abort",s)),n.addEventListener("abort",s,{once:!0})),{promise:e.ignoreCancel?o.catch(i=>{if(!(i instanceof Ue))throw i;return Qr}):o,cancel(){t.abort(new Ue)}}}class Yr{_basePathname;_map=new Map;_templateLoadTask;_templateLoaded;constructor(e="/"){this._basePathname=e,this._basePathname.endsWith("/")||(this._basePathname=this._basePathname+"/")}async invalidate(e){if(!this._map.has(e))return{type:"none"};const t=Zr(e);let s;return this._templateLoaded===e?s=await this._fetchTemplate(e).promise:s=await this._fetchFiles(e),{type:t,files:s}}async getLessonTemplate(e){const t=`template-${e.data.template}.json`;return this._map.has(t)?this._map.get(t):this._templateLoadTask&&this._templateLoaded===t?this._templateLoadTask.promise:this._fetchTemplate(t).promise}getLessonFiles(e){return this._getFilesFromFilesRefList(e.files)}getLessonSolution(e){return this._getFilesFromFilesRefList(e.solution)}_fetchTemplate(e){this._templateLoadTask?.cancel();const t=q(async s=>{const n=await fetch(`${this._basePathname}${e}`,{signal:s});if(!n.ok)throw new Error(`Failed to fetch: status ${n.status}`);const o=Ct(await n.json());return this._map.set(e,o),s.throwIfAborted(),o});return this._templateLoadTask=t,this._templateLoaded=e,t}async _getFilesFromFilesRefList(e){if(e[1].length===0)return{};const t=e[0];return this._map.has(t)?this._map.get(t):this._fetchFiles(t)}async _fetchFiles(e){let t=2;for(;;){try{const s=await fetch(`${this._basePathname}${e}`);if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);const n=Ct(await s.json());return this._map.set(e,n),n}catch(s){if(t<=0)return console.error(`Failed to fetch ${e} after 3 attempts.`),console.error(s),{}}t-=1,await zr(1e3)}}}function Ct(r){const e={};if(typeof r!="object")return e;for(const t in r){const s=r[t];let n;typeof s=="object"?n=Uint8Array.from(atob(s.base64),o=>o.charCodeAt(0)):n=s,e[t]=n}return e}function Zr(r){return r.startsWith("template-")?"template":r.endsWith("files.json")?"files":"solution"}class St{_config;constructor(e){this._config=es(e)}get visible(){return this._config.visible}get fileTree(){return this._config.fileTree}}function es(r){return r===!1?{visible:!1,fileTree:{visible:!1,allowEdits:!1}}:r===void 0||r===!0?{visible:!0,fileTree:{visible:!0,allowEdits:!1}}:typeof r.fileTree=="boolean"?{visible:!0,fileTree:{visible:r.fileTree,allowEdits:!1}}:typeof r.fileTree?.allowEdits=="boolean"||!r.fileTree?.allowEdits?{visible:!0,fileTree:{visible:!0,allowEdits:r.fileTree?.allowEdits?["**"]:!1}}:{visible:!0,fileTree:{visible:!0,allowEdits:ts(r.fileTree.allowEdits)}}}function ts(r){return Array.isArray(r)?r:[r]}class rs{editorConfig=B(new St);selectedFile=B();documents=Gr({});files=yt(this.documents,e=>Object.entries(e).map(([t,s])=>({path:t,type:s?.type||"file"})));currentDocument=yt([this.documents,this.selectedFile],(e,t)=>{if(t)return e[t]});setEditorConfig(e){this.editorConfig.set(new St(e))}setSelectedFile(e){this.selectedFile.set(e)}setDocuments(e){const t="file";if(Array.isArray(e))this.documents.set(Object.fromEntries(e[1].map(s=>[s,{value:"",type:t,loading:!0,filePath:s}])));else{const s=this.documents.value;this.documents.set(Object.fromEntries(Object.entries(e).map(([n,o])=>[n,{value:o,type:t,loading:!1,filePath:n,scroll:s?.[n]?.scroll}])))}}updateScrollPosition(e,t){const s=this.documents.get()[e];s&&this.documents.setKey(e,{...s,scroll:t})}addFileOrFolder(e){const t=this.files.get().find(s=>e.path.startsWith(s.path));t&&this.documents.setKey(t.path,void 0),this.documents.setKey(e.path,{filePath:e.path,type:e.type,value:"",loading:!1})}updateFile(e,t){const s=this.documents.get()[e];if(!s)return!1;const o=s.value!==t;return o&&this.documents.setKey(e,{...s,value:t}),o}deleteFile(e){return this.documents.get()[e]?(this.documents.setKey(e,void 0),!0):!1}onDocumentChanged(e,t){const s=this.currentDocument.subscribe(o=>{o?.filePath===e&&t(o)}),n=this.documents.subscribe(o=>{const i=o[e];i&&!i.loading&&queueMicrotask(()=>{t(i),n()})});return()=>{n(),s()}}}class ss{_availablePreviews=new Map;_previewsLayout=[];previews=B([]);constructor(e){this._init(e)}async _init(e){(await e).on("port",(s,n,o)=>{let i=this._availablePreviews.get(s);i||(i=new bt(s,o,n==="open"),this._availablePreviews.set(s,i)),i.ready=n==="open",i.origin=o,this._previewsLayout.length===0?this.previews.set([new Re({},i)]):(this._previewsLayout=[...this._previewsLayout],this.previews.set(this._previewsLayout))})}setPreviews(e){if(e===!1){this.previews.set([]);return}const t=e===!0?[]:e??[],s=t.map(o=>{const i=Re.parse(o);let a=this._availablePreviews.get(i.port);return a||(a=new bt(i.port),this._availablePreviews.set(i.port,a)),new Re(i,a)});let n=s.length!=this._previewsLayout.length;if(!n)for(let o=0;o<s.length&&(n=!Re.equals(s[o],this._previewsLayout[o]),!n);o++);if(n)if(this._previewsLayout=s,t.length===0){const o=this._availablePreviews.values().next().value;this.previews.set(o?[o]:[])}else this.previews.set(this._previewsLayout)}}function ns(){try{const r="SharedArrayBuffer"in globalThis,e=navigator.userAgent.includes("Chrome"),t=navigator.userAgent.includes("Firefox"),s=navigator.userAgent.includes("Safari");if(r&&(e||t))return!0;if(r&&s){const n=navigator.userAgent.match(/Version\/(\d+)\.(\d+) (?:Mobile\/.*?)?Safari/),o=n?Number(n?.[1]):0,i=n?Number(n?.[2]):0;return o>16||o===16&&i>=4}return!!localStorage.getItem("webcontainer_any_ua")}catch{return!1}}const fe="\x1B[0m",_e={reset:fe,clear:"\x1B[g",red:r=>`\x1B[1;31m${r}${fe}`,gray:r=>`\x1B[37m${r}${fe}`,green:r=>`\x1B[1;32m${r}${fe}`,magenta:r=>`\x1B[35m${r}${fe}`};function Te(r){r?.reset(),r?.write(_e.clear)}async function os(r,e,t){const s=[];t?.allowRedirects||s.push("--no-redirects"),Array.isArray(t?.allowCommands)&&s.push("--allow-commands",t.allowCommands.join(","));const n=await r.spawn("/bin/jsh",["--osc",...s],{terminal:{cols:e.cols??80,rows:e.rows??15}}),o=n.input.getWriter(),i=n.output,a=jt();let f=!1;return i.pipeTo(new WritableStream({write(h){if(!f){const[,p]=h.match(/\x1b\]654;([^\x07]+)\x07/)||[];p==="interactive"&&(f=!0,a.resolve())}e.write(h)}})),e.onData(h=>{f&&o.write(h)}),await a.promise,n}class At{_config;constructor(e){const t=cs(e);this._config=t}get panels(){return this._config.panels}get activePanel(){return this._config.activePanel}get defaultOpen(){return this._config.defaultOpen}}const is={output:"Output",terminal:"Terminal"};let as=0;class K{type;_options;static panelCount={output:0,terminal:0};static resetCount(){this.panelCount={output:0,terminal:0}}id;title;_terminal;_process;_data=[];_onData;constructor(e,t){this.type=e,this._options=t;let s=t?.title;if(!s){s=is[e];const n=K.panelCount[e];n>0&&(s+=` ${n}`),K.panelCount[e]++}this.title=s,this.id=t?.id??(e==="output"?"output":`${e}-${as++}`)}get terminal(){return this._terminal}get process(){return this._process}get processOptions(){if(this.type!=="output")return{allowRedirects:this._options?.allowRedirects??!1,allowCommands:this._options?.allowCommands}}get cols(){return this._terminal?.cols}get rows(){return this._terminal?.rows}reset(){this._terminal?this._terminal.reset():this._data=[]}write(e){this._terminal?this._terminal.write(e):this._data.push({data:e,type:"echo"})}input(e){if(this.type!=="terminal")throw new Error("Cannot write data to output-only terminal");this._terminal?this._terminal.input(e):this._data.push({data:e,type:"input"})}onData(e){this._terminal?this._terminal.onData(e):this._onData=e}attachProcess(e){this._process=e,this.cols!=null&&this.rows!=null&&this._process.resize({cols:this.cols,rows:this.rows})}attachTerminal(e){for(const{type:t,data:s}of this._data)t==="echo"?e.write(s):e.input(s);this._data=[],this._terminal=e,this._onData&&e.onData(this._onData),this.cols!=null&&this.rows!=null&&this._process?.resize({cols:this.cols,rows:this.rows})}}function cs(r){let e=0;if(r===!1)return{panels:[],activePanel:e,defaultOpen:!1};if(K.resetCount(),r===void 0||r===!0)return{panels:[new K("output")],activePanel:e,defaultOpen:!1};const t=[],s={allowRedirects:r.allowRedirects,allowCommands:r.allowCommands};if(r.panels){if(r.panels==="output")t.push(new K("output"));else if(r.panels==="terminal")t.push(new K("terminal",s));else if(Array.isArray(r.panels))for(const n of r.panels){let o;typeof n=="string"?o=new K(n,s):Array.isArray(n)?o=new K(n[0],{title:n[1],...s}):o=new K(n.type,{id:n.id,title:n.title,allowRedirects:n.allowRedirects??r.allowRedirects,allowCommands:n.allowCommands??r.allowCommands}),t.push(o)}}return typeof r.activePanel=="number"&&(e=r.activePanel,e>=t.length&&(e=0)),{activePanel:e,panels:t,defaultOpen:r.open||!1}}class us{_webcontainer;_useAuth;terminalConfig=B(new At);_output=void 0;_webcontainerLoaded=!1;constructor(e,t){this._webcontainer=e,this._useAuth=t,this._webcontainer.then(()=>{this._webcontainerLoaded=!0})}getOutputPanel(){return this._output}hasTerminalPanel(){return this.terminalConfig.get().panels.length>0}setTerminalConfiguration(e){const t=this.terminalConfig.get(),s=new At(e),n=new Map(t.panels.map(o=>[o.id,o]));for(const o of s.panels){const i=n.get(o.id);n.delete(o.id),i?.terminal&&o.attachTerminal(i.terminal),o.type==="output"&&(this._output=o),o.type==="terminal"&&!i&&this._bootWebContainer(o).then(async a=>{o.attachProcess(await os(a,o,o.processOptions))}).catch(()=>{})}for(const o of n.values())o.process?.kill();this.terminalConfig.set(s)}async attachTerminal(e,t){const s=this.terminalConfig.get().panels.find(n=>n.id===e);s&&s.attachTerminal(t)}onTerminalResize(e,t){for(const s of this.terminalConfig.get().panels)s.process?.resize({cols:e,rows:t})}async _bootWebContainer(e){ls(e);const t=this._webcontainerLoaded;this._useAuth&&!t&&(e.write("Waiting for authentication to complete..."),await de.loggedIn(),Te(e)),t||e.write("Booting WebContainer...");try{const s=await this._webcontainer;return t||Te(e),s}catch(s){throw Te(e),await jr(),e.write([_e.red("Looks like your browser's configuration is blocking WebContainers."),"","Let's troubleshoot this!","","Read more at:","https://webcontainers.io/guides/browser-config",""].join(`
`)),s}}}function ls(r){if(!ns())throw r.write([_e.red("Incompatible Web Browser"),"","WebContainers currently work in Chromium-based browsers, Firefox, and Safari 16.4. We're hoping to add support for more browsers as they implement the necessary Web Platform features.","","Read more about browser support:","https://webcontainers.io/guides/browser-support",""].join(`
`)),new Error("Incompatible Web Browser")}var Pe={};const j="\\\\/",Et=`[^${j}]`,Q="\\.",fs="\\+",hs="\\?",Oe="\\/",ps="(?=.)",Kt="[^/]",lt=`(?:${Oe}|$)`,Vt=`(?:^|${Oe})`,ft=`${Q}{1,2}${lt}`,ds=`(?!${Q})`,_s=`(?!${Vt}${ft})`,ms=`(?!${Q}{0,1}${lt})`,ws=`(?!${ft})`,gs=`[^.${Oe}]`,ys=`${Kt}*?`,bs="/",Jt={DOT_LITERAL:Q,PLUS_LITERAL:fs,QMARK_LITERAL:hs,SLASH_LITERAL:Oe,ONE_CHAR:ps,QMARK:Kt,END_ANCHOR:lt,DOTS_SLASH:ft,NO_DOT:ds,NO_DOTS:_s,NO_DOT_SLASH:ms,NO_DOTS_SLASH:ws,QMARK_NO_DOT:gs,STAR:ys,START_ANCHOR:Vt,SEP:bs},Cs={...Jt,SLASH_LITERAL:`[${j}]`,QMARK:Et,STAR:`${Et}*?`,DOTS_SLASH:`${Q}{1,2}(?:[${j}]|$)`,NO_DOT:`(?!${Q})`,NO_DOTS:`(?!(?:^|[${j}])${Q}{1,2}(?:[${j}]|$))`,NO_DOT_SLASH:`(?!${Q}{0,1}(?:[${j}]|$))`,NO_DOTS_SLASH:`(?!${Q}{1,2}(?:[${j}]|$))`,QMARK_NO_DOT:`[^.${j}]`,START_ANCHOR:`(?:^|[${j}])`,END_ANCHOR:`(?:[${j}]|$)`,SEP:"\\"},Ss={alnum:"a-zA-Z0-9",alpha:"a-zA-Z",ascii:"\\x00-\\x7F",blank:" \\t",cntrl:"\\x00-\\x1F\\x7F",digit:"0-9",graph:"\\x21-\\x7E",lower:"a-z",print:"\\x20-\\x7E ",punct:"\\-!\"#$%&'()\\*+,./:;<=>?@[\\]^_`{|}~",space:" \\t\\r\\n\\v\\f",upper:"A-Z",word:"A-Za-z0-9_",xdigit:"A-Fa-f0-9"};var Fe={MAX_LENGTH:1024*64,POSIX_REGEX_SOURCE:Ss,REGEX_BACKSLASH:/\\(?![*+?^${}(|)[\]])/g,REGEX_NON_SPECIAL_CHARS:/^[^@![\].,$*+?^{}()|\\/]+/,REGEX_SPECIAL_CHARS:/[-*+?.^${}(|)[\]]/,REGEX_SPECIAL_CHARS_BACKREF:/(\\?)((\W)(\3*))/g,REGEX_SPECIAL_CHARS_GLOBAL:/([-*+?.^${}(|)[\]])/g,REGEX_REMOVE_BACKSLASH:/(?:\[.*?[^\\]\]|\\(?=.))/g,REPLACEMENTS:{"***":"*","**/**":"**","**/**/**":"**"},CHAR_0:48,CHAR_9:57,CHAR_UPPERCASE_A:65,CHAR_LOWERCASE_A:97,CHAR_UPPERCASE_Z:90,CHAR_LOWERCASE_Z:122,CHAR_LEFT_PARENTHESES:40,CHAR_RIGHT_PARENTHESES:41,CHAR_ASTERISK:42,CHAR_AMPERSAND:38,CHAR_AT:64,CHAR_BACKWARD_SLASH:92,CHAR_CARRIAGE_RETURN:13,CHAR_CIRCUMFLEX_ACCENT:94,CHAR_COLON:58,CHAR_COMMA:44,CHAR_DOT:46,CHAR_DOUBLE_QUOTE:34,CHAR_EQUAL:61,CHAR_EXCLAMATION_MARK:33,CHAR_FORM_FEED:12,CHAR_FORWARD_SLASH:47,CHAR_GRAVE_ACCENT:96,CHAR_HASH:35,CHAR_HYPHEN_MINUS:45,CHAR_LEFT_ANGLE_BRACKET:60,CHAR_LEFT_CURLY_BRACE:123,CHAR_LEFT_SQUARE_BRACKET:91,CHAR_LINE_FEED:10,CHAR_NO_BREAK_SPACE:160,CHAR_PERCENT:37,CHAR_PLUS:43,CHAR_QUESTION_MARK:63,CHAR_RIGHT_ANGLE_BRACKET:62,CHAR_RIGHT_CURLY_BRACE:125,CHAR_RIGHT_SQUARE_BRACKET:93,CHAR_SEMICOLON:59,CHAR_SINGLE_QUOTE:39,CHAR_SPACE:32,CHAR_TAB:9,CHAR_UNDERSCORE:95,CHAR_VERTICAL_LINE:124,CHAR_ZERO_WIDTH_NOBREAK_SPACE:65279,extglobChars(r){return{"!":{type:"negate",open:"(?:(?!(?:",close:`))${r.STAR})`},"?":{type:"qmark",open:"(?:",close:")?"},"+":{type:"plus",open:"(?:",close:")+"},"*":{type:"star",open:"(?:",close:")*"},"@":{type:"at",open:"(?:",close:")"}}},globChars(r){return r===!0?Cs:Jt}};(function(r){const{REGEX_BACKSLASH:e,REGEX_REMOVE_BACKSLASH:t,REGEX_SPECIAL_CHARS:s,REGEX_SPECIAL_CHARS_GLOBAL:n}=Fe;r.isObject=o=>o!==null&&typeof o=="object"&&!Array.isArray(o),r.hasRegexChars=o=>s.test(o),r.isRegexChar=o=>o.length===1&&r.hasRegexChars(o),r.escapeRegex=o=>o.replace(n,"\\$1"),r.toPosixSlashes=o=>o.replace(e,"/"),r.isWindows=()=>{if(typeof navigator<"u"&&navigator.platform){const o=navigator.platform.toLowerCase();return o==="win32"||o==="windows"}return typeof process<"u"&&process.platform?process.platform==="win32":!1},r.removeBackslashes=o=>o.replace(t,i=>i==="\\"?"":i),r.escapeLast=(o,i,a)=>{const f=o.lastIndexOf(i,a);return f===-1?o:o[f-1]==="\\"?r.escapeLast(o,i,f-1):`${o.slice(0,f)}\\${o.slice(f)}`},r.removePrefix=(o,i={})=>{let a=o;return a.startsWith("./")&&(a=a.slice(2),i.prefix="./"),a},r.wrapOutput=(o,i={},a={})=>{const f=a.contains?"":"^",h=a.contains?"":"$";let p=`${f}(?:${o})${h}`;return i.negated===!0&&(p=`(?:^(?!${p}).*$)`),p},r.basename=(o,{windows:i}={})=>{const a=o.split(i?/[\\/]/:"/"),f=a[a.length-1];return f===""?a[a.length-2]:f}})(Pe);const Rt=Pe,{CHAR_ASTERISK:Be,CHAR_AT:As,CHAR_BACKWARD_SLASH:pe,CHAR_COMMA:Es,CHAR_DOT:Ge,CHAR_EXCLAMATION_MARK:ze,CHAR_FORWARD_SLASH:qt,CHAR_LEFT_CURLY_BRACE:je,CHAR_LEFT_PARENTHESES:Xe,CHAR_LEFT_SQUARE_BRACKET:Rs,CHAR_PLUS:vs,CHAR_QUESTION_MARK:vt,CHAR_RIGHT_CURLY_BRACE:Ts,CHAR_RIGHT_PARENTHESES:Tt,CHAR_RIGHT_SQUARE_BRACKET:ks}=Fe,kt=r=>r===qt||r===pe,Lt=r=>{r.isPrefix!==!0&&(r.depth=r.isGlobstar?1/0:1)},Ls=(r,e)=>{const t=e||{},s=r.length-1,n=t.parts===!0||t.scanToEnd===!0,o=[],i=[],a=[];let f=r,h=-1,p=0,m=0,S=!1,T=!1,A=!1,x=!1,Z=!1,G=!1,R=!1,z=!1,ee=!1,H=!1,I=0,M,g,b={value:"",depth:0,isGlob:!1};const l=()=>h>=s,N=()=>f.charCodeAt(h+1),F=()=>(M=g,f.charCodeAt(++h));for(;h<s;){g=F();let E;if(g===pe){R=b.backslashes=!0,g=F(),g===je&&(G=!0);continue}if(G===!0||g===je){for(I++;l()!==!0&&(g=F());){if(g===pe){R=b.backslashes=!0,F();continue}if(g===je){I++;continue}if(G!==!0&&g===Ge&&(g=F())===Ge){if(S=b.isBrace=!0,A=b.isGlob=!0,H=!0,n===!0)continue;break}if(G!==!0&&g===Es){if(S=b.isBrace=!0,A=b.isGlob=!0,H=!0,n===!0)continue;break}if(g===Ts&&(I--,I===0)){G=!1,S=b.isBrace=!0,H=!0;break}}if(n===!0)continue;break}if(g===qt){if(o.push(h),i.push(b),b={value:"",depth:0,isGlob:!1},H===!0)continue;if(M===Ge&&h===p+1){p+=2;continue}m=h+1;continue}if(t.noext!==!0&&(g===vs||g===As||g===Be||g===vt||g===ze)===!0&&N()===Xe){if(A=b.isGlob=!0,x=b.isExtglob=!0,H=!0,g===ze&&h===p&&(ee=!0),n===!0){for(;l()!==!0&&(g=F());){if(g===pe){R=b.backslashes=!0,g=F();continue}if(g===Tt){A=b.isGlob=!0,H=!0;break}}continue}break}if(g===Be){if(M===Be&&(Z=b.isGlobstar=!0),A=b.isGlob=!0,H=!0,n===!0)continue;break}if(g===vt){if(A=b.isGlob=!0,H=!0,n===!0)continue;break}if(g===Rs){for(;l()!==!0&&(E=F());){if(E===pe){R=b.backslashes=!0,F();continue}if(E===ks){T=b.isBracket=!0,A=b.isGlob=!0,H=!0;break}}if(n===!0)continue;break}if(t.nonegate!==!0&&g===ze&&h===p){z=b.negated=!0,p++;continue}if(t.noparen!==!0&&g===Xe){if(A=b.isGlob=!0,n===!0){for(;l()!==!0&&(g=F());){if(g===Xe){R=b.backslashes=!0,g=F();continue}if(g===Tt){H=!0;break}}continue}break}if(A===!0){if(H=!0,n===!0)continue;break}}t.noext===!0&&(x=!1,A=!1);let P=f,c="",u="";p>0&&(c=f.slice(0,p),f=f.slice(p),m-=p),P&&A===!0&&m>0?(P=f.slice(0,m),u=f.slice(m)):A===!0?(P="",u=f):P=f,P&&P!==""&&P!=="/"&&P!==f&&kt(P.charCodeAt(P.length-1))&&(P=P.slice(0,-1)),t.unescape===!0&&(u&&(u=Rt.removeBackslashes(u)),P&&R===!0&&(P=Rt.removeBackslashes(P)));const W={prefix:c,input:r,start:p,base:P,glob:u,isBrace:S,isBracket:T,isGlob:A,isExtglob:x,isGlobstar:Z,negated:z,negatedExtglob:ee};if(t.tokens===!0&&(W.maxDepth=0,kt(g)||i.push(b),W.tokens=i),t.parts===!0||t.tokens===!0){let E;for(let k=0;k<o.length;k++){const J=E?E+1:p,U=o[k],Y=r.slice(J,U);t.tokens&&(k===0&&p!==0?(i[k].isPrefix=!0,i[k].value=c):i[k].value=Y,Lt(i[k]),W.maxDepth+=i[k].depth),(k!==0||Y!=="")&&a.push(Y),E=U}if(E&&E+1<r.length){const k=r.slice(E+1);a.push(k),t.tokens&&(i[i.length-1].value=k,Lt(i[i.length-1]),W.maxDepth+=i[i.length-1].depth)}W.slashes=o,W.parts=a}return W};var xs=Ls;const Le=Fe,X=Pe,{MAX_LENGTH:xe,POSIX_REGEX_SOURCE:Ps,REGEX_NON_SPECIAL_CHARS:Os,REGEX_SPECIAL_CHARS_BACKREF:Fs,REPLACEMENTS:Qt}=Le,$s=(r,e)=>{if(typeof e.expandRange=="function")return e.expandRange(...r,e);r.sort();const t=`[${r.join("-")}]`;try{new RegExp(t)}catch{return r.map(n=>X.escapeRegex(n)).join("..")}return t},ce=(r,e)=>`Missing ${r}: "${e}" - use "\\\\${e}" to match literal characters`,ht=(r,e)=>{if(typeof r!="string")throw new TypeError("Expected a string");r=Qt[r]||r;const t={...e},s=typeof t.maxLength=="number"?Math.min(xe,t.maxLength):xe;let n=r.length;if(n>s)throw new SyntaxError(`Input length: ${n}, exceeds maximum allowed length: ${s}`);const o={type:"bos",value:"",output:t.prepend||""},i=[o],a=t.capture?"":"?:",f=Le.globChars(t.windows),h=Le.extglobChars(f),{DOT_LITERAL:p,PLUS_LITERAL:m,SLASH_LITERAL:S,ONE_CHAR:T,DOTS_SLASH:A,NO_DOT:x,NO_DOT_SLASH:Z,NO_DOTS_SLASH:G,QMARK:R,QMARK_NO_DOT:z,STAR:ee,START_ANCHOR:H}=f,I=_=>`(${a}(?:(?!${H}${_.dot?A:p}).)*?)`,M=t.dot?"":x,g=t.dot?R:z;let b=t.bash===!0?I(t):ee;t.capture&&(b=`(${b})`),typeof t.noext=="boolean"&&(t.noextglob=t.noext);const l={input:r,index:-1,start:0,dot:t.dot===!0,consumed:"",output:"",prefix:"",backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:i};r=X.removePrefix(r,l),n=r.length;const N=[],F=[],P=[];let c=o,u;const W=()=>l.index===n-1,E=l.peek=(_=1)=>r[l.index+_],k=l.advance=()=>r[++l.index]||"",J=()=>r.slice(l.index+1),U=(_="",v=0)=>{l.consumed+=_,l.index+=v},Y=_=>{l.output+=_.output!=null?_.output:_.value,U(_.value)},Zt=()=>{let _=1;for(;E()==="!"&&(E(2)!=="("||E(3)==="?");)k(),l.start++,_++;return _%2===0?!1:(l.negated=!0,l.start++,!0)},me=_=>{l[_]++,P.push(_)},te=_=>{l[_]--,P.pop()},C=_=>{if(c.type==="globstar"){const v=l.braces>0&&(_.type==="comma"||_.type==="brace"),d=_.extglob===!0||N.length&&(_.type==="pipe"||_.type==="paren");_.type!=="slash"&&_.type!=="paren"&&!v&&!d&&(l.output=l.output.slice(0,-c.output.length),c.type="star",c.value="*",c.output=b,l.output+=c.output)}if(N.length&&_.type!=="paren"&&(N[N.length-1].inner+=_.value),(_.value||_.output)&&Y(_),c&&c.type==="text"&&_.type==="text"){c.output=(c.output||c.value)+_.value,c.value+=_.value;return}_.prev=c,i.push(_),c=_},we=(_,v)=>{const d={...h[v],conditions:1,inner:""};d.prev=c,d.parens=l.parens,d.output=l.output;const y=(t.capture?"(":"")+d.open;me("parens"),C({type:_,value:v,output:l.output?"":T}),C({type:"paren",extglob:!0,value:k(),output:y}),N.push(d)},er=_=>{let v=_.close+(t.capture?")":""),d;if(_.type==="negate"){let y=b;if(_.inner&&_.inner.length>1&&_.inner.includes("/")&&(y=I(t)),(y!==b||W()||/^\)+$/.test(J()))&&(v=_.close=`)$))${y}`),_.inner.includes("*")&&(d=J())&&/^\.[^\\/.]+$/.test(d)){const L=ht(d,{...e,fastpaths:!1}).output;v=_.close=`)${L})${y})`}_.prev.type==="bos"&&(l.negatedExtglob=!0)}C({type:"paren",extglob:!0,value:u,output:v}),te("parens")};if(t.fastpaths!==!1&&!/(^[*!]|[/()[\]{}"])/.test(r)){let _=!1,v=r.replace(Fs,(d,y,L,D,$,$e)=>D==="\\"?(_=!0,d):D==="?"?y?y+D+($?R.repeat($.length):""):$e===0?g+($?R.repeat($.length):""):R.repeat(L.length):D==="."?p.repeat(L.length):D==="*"?y?y+D+($?b:""):b:y?d:`\\${d}`);return _===!0&&(t.unescape===!0?v=v.replace(/\\/g,""):v=v.replace(/\\+/g,d=>d.length%2===0?"\\\\":d?"\\":"")),v===r&&t.contains===!0?(l.output=r,l):(l.output=X.wrapOutput(v,l,e),l)}for(;!W();){if(u=k(),u==="\0")continue;if(u==="\\"){const d=E();if(d==="/"&&t.bash!==!0||d==="."||d===";")continue;if(!d){u+="\\",C({type:"text",value:u});continue}const y=/^\\+/.exec(J());let L=0;if(y&&y[0].length>2&&(L=y[0].length,l.index+=L,L%2!==0&&(u+="\\")),t.unescape===!0?u=k():u+=k(),l.brackets===0){C({type:"text",value:u});continue}}if(l.brackets>0&&(u!=="]"||c.value==="["||c.value==="[^")){if(t.posix!==!1&&u===":"){const d=c.value.slice(1);if(d.includes("[")&&(c.posix=!0,d.includes(":"))){const y=c.value.lastIndexOf("["),L=c.value.slice(0,y),D=c.value.slice(y+2),$=Ps[D];if($){c.value=L+$,l.backtrack=!0,k(),!o.output&&i.indexOf(c)===1&&(o.output=T);continue}}}(u==="["&&E()!==":"||u==="-"&&E()==="]")&&(u=`\\${u}`),u==="]"&&(c.value==="["||c.value==="[^")&&(u=`\\${u}`),t.posix===!0&&u==="!"&&c.value==="["&&(u="^"),c.value+=u,Y({value:u});continue}if(l.quotes===1&&u!=='"'){u=X.escapeRegex(u),c.value+=u,Y({value:u});continue}if(u==='"'){l.quotes=l.quotes===1?0:1,t.keepQuotes===!0&&C({type:"text",value:u});continue}if(u==="("){me("parens"),C({type:"paren",value:u});continue}if(u===")"){if(l.parens===0&&t.strictBrackets===!0)throw new SyntaxError(ce("opening","("));const d=N[N.length-1];if(d&&l.parens===d.parens+1){er(N.pop());continue}C({type:"paren",value:u,output:l.parens?")":"\\)"}),te("parens");continue}if(u==="["){if(t.nobracket===!0||!J().includes("]")){if(t.nobracket!==!0&&t.strictBrackets===!0)throw new SyntaxError(ce("closing","]"));u=`\\${u}`}else me("brackets");C({type:"bracket",value:u});continue}if(u==="]"){if(t.nobracket===!0||c&&c.type==="bracket"&&c.value.length===1){C({type:"text",value:u,output:`\\${u}`});continue}if(l.brackets===0){if(t.strictBrackets===!0)throw new SyntaxError(ce("opening","["));C({type:"text",value:u,output:`\\${u}`});continue}te("brackets");const d=c.value.slice(1);if(c.posix!==!0&&d[0]==="^"&&!d.includes("/")&&(u=`/${u}`),c.value+=u,Y({value:u}),t.literalBrackets===!1||X.hasRegexChars(d))continue;const y=X.escapeRegex(c.value);if(l.output=l.output.slice(0,-c.value.length),t.literalBrackets===!0){l.output+=y,c.value=y;continue}c.value=`(${a}${y}|${c.value})`,l.output+=c.value;continue}if(u==="{"&&t.nobrace!==!0){me("braces");const d={type:"brace",value:u,output:"(",outputIndex:l.output.length,tokensIndex:l.tokens.length};F.push(d),C(d);continue}if(u==="}"){const d=F[F.length-1];if(t.nobrace===!0||!d){C({type:"text",value:u,output:u});continue}let y=")";if(d.dots===!0){const L=i.slice(),D=[];for(let $=L.length-1;$>=0&&(i.pop(),L[$].type!=="brace");$--)L[$].type!=="dots"&&D.unshift(L[$].value);y=$s(D,t),l.backtrack=!0}if(d.comma!==!0&&d.dots!==!0){const L=l.output.slice(0,d.outputIndex),D=l.tokens.slice(d.tokensIndex);d.value=d.output="\\{",u=y="\\}",l.output=L;for(const $ of D)l.output+=$.output||$.value}C({type:"brace",value:u,output:y}),te("braces"),F.pop();continue}if(u==="|"){N.length>0&&N[N.length-1].conditions++,C({type:"text",value:u});continue}if(u===","){let d=u;const y=F[F.length-1];y&&P[P.length-1]==="braces"&&(y.comma=!0,d="|"),C({type:"comma",value:u,output:d});continue}if(u==="/"){if(c.type==="dot"&&l.index===l.start+1){l.start=l.index+1,l.consumed="",l.output="",i.pop(),c=o;continue}C({type:"slash",value:u,output:S});continue}if(u==="."){if(l.braces>0&&c.type==="dot"){c.value==="."&&(c.output=p);const d=F[F.length-1];c.type="dots",c.output+=u,c.value+=u,d.dots=!0;continue}if(l.braces+l.parens===0&&c.type!=="bos"&&c.type!=="slash"){C({type:"text",value:u,output:p});continue}C({type:"dot",value:u,output:p});continue}if(u==="?"){if(!(c&&c.value==="(")&&t.noextglob!==!0&&E()==="("&&E(2)!=="?"){we("qmark",u);continue}if(c&&c.type==="paren"){const y=E();let L=u;(c.value==="("&&!/[!=<:]/.test(y)||y==="<"&&!/<([!=]|\w+>)/.test(J()))&&(L=`\\${u}`),C({type:"text",value:u,output:L});continue}if(t.dot!==!0&&(c.type==="slash"||c.type==="bos")){C({type:"qmark",value:u,output:z});continue}C({type:"qmark",value:u,output:R});continue}if(u==="!"){if(t.noextglob!==!0&&E()==="("&&(E(2)!=="?"||!/[!=<:]/.test(E(3)))){we("negate",u);continue}if(t.nonegate!==!0&&l.index===0){Zt();continue}}if(u==="+"){if(t.noextglob!==!0&&E()==="("&&E(2)!=="?"){we("plus",u);continue}if(c&&c.value==="("||t.regex===!1){C({type:"plus",value:u,output:m});continue}if(c&&(c.type==="bracket"||c.type==="paren"||c.type==="brace")||l.parens>0){C({type:"plus",value:u});continue}C({type:"plus",value:m});continue}if(u==="@"){if(t.noextglob!==!0&&E()==="("&&E(2)!=="?"){C({type:"at",extglob:!0,value:u,output:""});continue}C({type:"text",value:u});continue}if(u!=="*"){(u==="$"||u==="^")&&(u=`\\${u}`);const d=Os.exec(J());d&&(u+=d[0],l.index+=d[0].length),C({type:"text",value:u});continue}if(c&&(c.type==="globstar"||c.star===!0)){c.type="star",c.star=!0,c.value+=u,c.output=b,l.backtrack=!0,l.globstar=!0,U(u);continue}let _=J();if(t.noextglob!==!0&&/^\([^?]/.test(_)){we("star",u);continue}if(c.type==="star"){if(t.noglobstar===!0){U(u);continue}const d=c.prev,y=d.prev,L=d.type==="slash"||d.type==="bos",D=y&&(y.type==="star"||y.type==="globstar");if(t.bash===!0&&(!L||_[0]&&_[0]!=="/")){C({type:"star",value:u,output:""});continue}const $=l.braces>0&&(d.type==="comma"||d.type==="brace"),$e=N.length&&(d.type==="pipe"||d.type==="paren");if(!L&&d.type!=="paren"&&!$&&!$e){C({type:"star",value:u,output:""});continue}for(;_.slice(0,3)==="/**";){const ge=r[l.index+4];if(ge&&ge!=="/")break;_=_.slice(3),U("/**",3)}if(d.type==="bos"&&W()){c.type="globstar",c.value+=u,c.output=I(t),l.output=c.output,l.globstar=!0,U(u);continue}if(d.type==="slash"&&d.prev.type!=="bos"&&!D&&W()){l.output=l.output.slice(0,-(d.output+c.output).length),d.output=`(?:${d.output}`,c.type="globstar",c.output=I(t)+(t.strictSlashes?")":"|$)"),c.value+=u,l.globstar=!0,l.output+=d.output+c.output,U(u);continue}if(d.type==="slash"&&d.prev.type!=="bos"&&_[0]==="/"){const ge=_[1]!==void 0?"|$":"";l.output=l.output.slice(0,-(d.output+c.output).length),d.output=`(?:${d.output}`,c.type="globstar",c.output=`${I(t)}${S}|${S}${ge})`,c.value+=u,l.output+=d.output+c.output,l.globstar=!0,U(u+k()),C({type:"slash",value:"/",output:""});continue}if(d.type==="bos"&&_[0]==="/"){c.type="globstar",c.value+=u,c.output=`(?:^|${S}|${I(t)}${S})`,l.output=c.output,l.globstar=!0,U(u+k()),C({type:"slash",value:"/",output:""});continue}l.output=l.output.slice(0,-c.output.length),c.type="globstar",c.output=I(t),c.value+=u,l.output+=c.output,l.globstar=!0,U(u);continue}const v={type:"star",value:u,output:b};if(t.bash===!0){v.output=".*?",(c.type==="bos"||c.type==="slash")&&(v.output=M+v.output),C(v);continue}if(c&&(c.type==="bracket"||c.type==="paren")&&t.regex===!0){v.output=u,C(v);continue}(l.index===l.start||c.type==="slash"||c.type==="dot")&&(c.type==="dot"?(l.output+=Z,c.output+=Z):t.dot===!0?(l.output+=G,c.output+=G):(l.output+=M,c.output+=M),E()!=="*"&&(l.output+=T,c.output+=T)),C(v)}for(;l.brackets>0;){if(t.strictBrackets===!0)throw new SyntaxError(ce("closing","]"));l.output=X.escapeLast(l.output,"["),te("brackets")}for(;l.parens>0;){if(t.strictBrackets===!0)throw new SyntaxError(ce("closing",")"));l.output=X.escapeLast(l.output,"("),te("parens")}for(;l.braces>0;){if(t.strictBrackets===!0)throw new SyntaxError(ce("closing","}"));l.output=X.escapeLast(l.output,"{"),te("braces")}if(t.strictSlashes!==!0&&(c.type==="star"||c.type==="bracket")&&C({type:"maybe_slash",value:"",output:`${S}?`}),l.backtrack===!0){l.output="";for(const _ of l.tokens)l.output+=_.output!=null?_.output:_.value,_.suffix&&(l.output+=_.suffix)}return l};ht.fastpaths=(r,e)=>{const t={...e},s=typeof t.maxLength=="number"?Math.min(xe,t.maxLength):xe,n=r.length;if(n>s)throw new SyntaxError(`Input length: ${n}, exceeds maximum allowed length: ${s}`);r=Qt[r]||r;const{DOT_LITERAL:o,SLASH_LITERAL:i,ONE_CHAR:a,DOTS_SLASH:f,NO_DOT:h,NO_DOTS:p,NO_DOTS_SLASH:m,STAR:S,START_ANCHOR:T}=Le.globChars(t.windows),A=t.dot?p:h,x=t.dot?m:h,Z=t.capture?"":"?:",G={negated:!1,prefix:""};let R=t.bash===!0?".*?":S;t.capture&&(R=`(${R})`);const z=M=>M.noglobstar===!0?R:`(${Z}(?:(?!${T}${M.dot?f:o}).)*?)`,ee=M=>{switch(M){case"*":return`${A}${a}${R}`;case".*":return`${o}${a}${R}`;case"*.*":return`${A}${R}${o}${a}${R}`;case"*/*":return`${A}${R}${i}${a}${x}${R}`;case"**":return A+z(t);case"**/*":return`(?:${A}${z(t)}${i})?${x}${a}${R}`;case"**/*.*":return`(?:${A}${z(t)}${i})?${x}${R}${o}${a}${R}`;case"**/.*":return`(?:${A}${z(t)}${i})?${o}${a}${R}`;default:{const g=/^(.*?)\.(\w+)$/.exec(M);if(!g)return;const b=ee(g[1]);return b?b+o+g[2]:void 0}}},H=X.removePrefix(r,G);let I=ee(H);return I&&t.strictSlashes!==!0&&(I+=`${i}?`),I};var Is=ht;const Hs=xs,et=Is,Yt=Pe,Ds=Fe,Ns=r=>r&&typeof r=="object"&&!Array.isArray(r),O=(r,e,t=!1)=>{if(Array.isArray(r)){const p=r.map(S=>O(S,e,t));return S=>{for(const T of p){const A=T(S);if(A)return A}return!1}}const s=Ns(r)&&r.tokens&&r.input;if(r===""||typeof r!="string"&&!s)throw new TypeError("Expected pattern to be a non-empty string");const n=e||{},o=n.windows,i=s?O.compileRe(r,e):O.makeRe(r,e,!1,!0),a=i.state;delete i.state;let f=()=>!1;if(n.ignore){const p={...e,ignore:null,onMatch:null,onResult:null};f=O(n.ignore,p,t)}const h=(p,m=!1)=>{const{isMatch:S,match:T,output:A}=O.test(p,i,e,{glob:r,posix:o}),x={glob:r,state:a,regex:i,posix:o,input:p,output:A,match:T,isMatch:S};return typeof n.onResult=="function"&&n.onResult(x),S===!1?(x.isMatch=!1,m?x:!1):f(p)?(typeof n.onIgnore=="function"&&n.onIgnore(x),x.isMatch=!1,m?x:!1):(typeof n.onMatch=="function"&&n.onMatch(x),m?x:!0)};return t&&(h.state=a),h};O.test=(r,e,t,{glob:s,posix:n}={})=>{if(typeof r!="string")throw new TypeError("Expected input to be a string");if(r==="")return{isMatch:!1,output:""};const o=t||{},i=o.format||(n?Yt.toPosixSlashes:null);let a=r===s,f=a&&i?i(r):r;return a===!1&&(f=i?i(r):r,a=f===s),(a===!1||o.capture===!0)&&(o.matchBase===!0||o.basename===!0?a=O.matchBase(r,e,t,n):a=e.exec(f)),{isMatch:!!a,match:a,output:f}};O.matchBase=(r,e,t)=>(e instanceof RegExp?e:O.makeRe(e,t)).test(Yt.basename(r));O.isMatch=(r,e,t)=>O(e,t)(r);O.parse=(r,e)=>Array.isArray(r)?r.map(t=>O.parse(t,e)):et(r,{...e,fastpaths:!1});O.scan=(r,e)=>Hs(r,e);O.compileRe=(r,e,t=!1,s=!1)=>{if(t===!0)return r.output;const n=e||{},o=n.contains?"":"^",i=n.contains?"":"$";let a=`${o}(?:${r.output})${i}`;r&&r.negated===!0&&(a=`^(?!${a}).*$`);const f=O.toRegex(a,e);return s===!0&&(f.state=r),f};O.makeRe=(r,e={},t=!1,s=!1)=>{if(!r||typeof r!="string")throw new TypeError("Expected a non-empty string");let n={negated:!1,fastpaths:!0};return e.fastpaths!==!1&&(r[0]==="."||r[0]==="*")&&(n.output=et.fastpaths(r,e)),n.output||(n=et(r,e)),O.compileRe(n,e,t,s)};O.toRegex=(r,e)=>{try{const t=e||{};return new RegExp(r,t.flags||(t.nocase?"i":""))}catch(t){if(e&&e.debug===!0)throw t;return/$^/}};O.constants=Ds;var Ms=O,Ws=Ms;const Us=rr(Ws);class Bs{_counts=new Map;increment(e){if(typeof e=="string"){const t=this._counts.get(e)??0;this._counts.set(e,t+1);return}e.forEach(t=>this.increment(t))}decrement(e){const t=this._counts.get(e)??0;return t===0?!0:(this._counts.set(e,t-1),t-1===0)}}function Gs(r,e){const t={},s=[];for(const n in r){const o=r[n],i=e[n];typeof i>"u"?s.push(n):o!==i&&(t[n]=i)}for(const n in e)n in r||(t[n]=e[n]);return{addedOrModified:t,removed:s}}function tt(r){const e={};for(const t in r){const s=t.split("/").filter(o=>o);let n=e;for(let o=0;o<s.length;++o){const i=s[o];if(o===s.length-1)n[i]={file:{contents:r[t]}};else{let a=n[i];zs(a),a||(a={directory:{}},n[i]=a),n=a.directory}}}return e}function zs(r){if(r&&!("directory"in r))throw new Error("Expected directory node")}class js{_webcontainer;_terminalStore;_editorStore;_stepController;_currentLoadTask=void 0;_currentProcessTask=void 0;_currentCommandProcess=void 0;_currentTemplate=void 0;_currentFiles=void 0;_currentRunCommands=void 0;_ignoreFileEvents=new Bs;_watcher;_watchContentFromWebContainer=!1;_readyToWatch=!1;_packageJsonDirty=!1;_commandsChanged=!1;_packageJsonContent="";_packageJsonPath="";constructor(e,t,s,n){this._webcontainer=e,this._terminalStore=t,this._editorStore=s,this._stepController=n}setWatchFromWebContainer(e){this._watchContentFromWebContainer=e,this._readyToWatch&&this._watchContentFromWebContainer?this._webcontainer.then(t=>this._setupWatcher(t)):this._watchContentFromWebContainer||this._stopWatcher()}setCommands(e){const t=new Ze(e);this._changeDetection(e)&&(this._stepController.setFromCommands([...t]),this._currentRunCommands=t,this._commandsChanged=!0)}onTerminalResize(e,t){this._currentCommandProcess?.resize({cols:e,rows:t})}createFolder(e){const t=this._currentLoadTask?.promise;this._currentLoadTask=q(async s=>{await t;const n=await this._webcontainer;s.throwIfAborted(),this._ignoreFileEvents.increment(e),await n.fs.mkdir(e)},{ignoreCancel:!0})}updateFile(e,t){const s=this._currentLoadTask?.promise;this._currentLoadTask=q(async n=>{await s;const o=await this._webcontainer;n.throwIfAborted(),this._ignoreFileEvents.increment(e),await o.fs.writeFile(e,t),this._updateCurrentFiles({[e]:t})},{ignoreCancel:!0})}updateFiles(e){const t=this._currentLoadTask?.promise;this._currentLoadTask=q(async s=>{await t;const n=await this._webcontainer;s.throwIfAborted(),this._ignoreFileEvents.increment(Object.keys(e)),await n.mount(tt(e)),this._updateCurrentFiles(e)},{ignoreCancel:!0})}async fileExists(e){return this._fsExists(e,"file")}async folderExists(e){return this._fsExists(e,"folder")}async _fsExists(e,t){if(this._currentFiles?.[e]||this._currentTemplate?.[e])return!0;const s=this._currentLoadTask?.promise;return new Promise(n=>{this._currentLoadTask=q(async()=>{await s;const o=await this._webcontainer;try{t==="file"?await o.fs.readFile(e):await o.fs.readdir(e),n(!0)}catch{n(!1)}},{ignoreCancel:!0})})}prepareFiles({files:e,template:t,signal:s,abortPreviousLoad:n=!0}){const o=this._currentLoadTask?.promise;return n&&this._currentLoadTask?.cancel(),this._currentLoadTask=q(async i=>{await o,this._readyToWatch=!1,this._stopWatcher();const a=await this._webcontainer;i.throwIfAborted(),[t,e]=await Promise.all([t,e]),i.throwIfAborted(),this._currentFiles||this._currentTemplate?await Xs(a,{...this._currentTemplate,...this._currentFiles},{...t,...e}):await a.mount(tt({...t,...e})),this._currentTemplate={...t},this._currentFiles={...e},this._updateDirtyState({...t,...e})},{ignoreCancel:!0,signal:s}),this._currentLoadTask.promise}runCommands({abortPreviousRun:e=!0}={}){const t=this._currentProcessTask,s=this._currentLoadTask?.promise,n=this._currentRunCommands,o=this._commandsChanged;if(!n)throw new Error("setCommands should be called before runCommands");this._currentProcessTask=q(async i=>{if(await s,i.aborted&&e&&t?.cancel(),i.throwIfAborted(),!(this._packageJsonDirty||o)){if(t){const h=()=>t.cancel();return i.addEventListener("abort",h,{once:!0}),t.promise}return}this._commandsChanged=!1,e&&t?.cancel(),await t?.promise;const f=await this._webcontainer;return i.throwIfAborted(),this._runCommands(f,n,i)},{ignoreCancel:!0})}restartLastRunCommands(){if(!this._currentRunCommands||!this._currentProcessTask)return;const e=this._currentRunCommands,t=this._currentProcessTask.promise,s=this._currentLoadTask?.promise;this._currentProcessTask.cancel(),this._currentProcessTask=q(async n=>{await Promise.all([t,s]);const o=await this._webcontainer;return n.throwIfAborted(),this._runCommands(o,e,n)},{ignoreCancel:!0})}takeSnapshot(){const e={};for(const[t,s]of Object.entries(this._currentTemplate||{}))typeof s=="string"&&(e[t.slice(1)]=s);for(const[t,s]of Object.entries(this._currentFiles||{}))typeof s=="string"&&(e[t.slice(1)]=s);if(this._packageJsonContent){let t;try{t=JSON.parse(this._packageJsonContent)}catch{}if(t&&!t.stackblitz?.startCommand){const s=this._currentRunCommands?.mainCommand?.shellCommand,o=[...(this._currentRunCommands?.prepareCommands||[]).map(i=>i.shellCommand),s].filter(Boolean).join(" && ");e[this._packageJsonPath.slice(1)]=JSON.stringify({...t,stackblitz:{startCommand:o}},null,2)}}return{files:e}}async _runCommands(e,t,s){const n=this._terminalStore.getOutputPanel();Te(n);const o=()=>this._currentCommandProcess?.kill();s.addEventListener("abort",o,{once:!0});let i=!0;try{const a=[...t];this._stepController.setFromCommands(a);let f=0;for(const[h,p]of a.entries()){const m=h===a.length-1&&!!t.mainCommand;if(!p.isRunnable()){this._stepController.updateStep(h,{title:p.title,status:"skipped"});continue}this._stepController.updateStep(h,{title:p.title,status:"running"}),f>0&&n?.write(`
`),f++,this._currentCommandProcess=await this._newProcess(e,n,p.shellCommand);try{s.throwIfAborted()}catch(T){throw this._stepController.skipRemaining(h),T}if(m&&(i=!1,this._setupWatcher(e),this._clearDirtyState()),await this._currentCommandProcess.exit!==0){this._stepController.updateStep(h,{title:p.title,status:"failed"}),this._stepController.skipRemaining(h+1),i=!1;break}else this._stepController.updateStep(h,{title:p.title,status:"completed"});try{s.throwIfAborted()}catch(T){throw this._stepController.skipRemaining(h+1),T}}i&&this._clearDirtyState(),this._setupWatcher(e)}finally{s.removeEventListener("abort",o)}}async _newProcess(e,t,s){const[n,...o]=s.split(" ");t?.write(`${_e.magenta("")} ${_e.green(n)} ${o.join(" ")}
`);const i=await e.spawn(n,o,{terminal:t?{cols:t.cols??80,rows:t.rows??15}:void 0});return i.output.pipeTo(new WritableStream({write:a=>t?.write(a)})),i}_updateDirtyState(e){for(const t in e)if(t.endsWith("/package.json")&&e[t]!=this._packageJsonContent){this._packageJsonContent=e[t],this._packageJsonPath=t,this._packageJsonDirty=!0;return}}_updateCurrentFiles(e){if(this._currentFiles)for(const t in e)this._currentFiles[t]=e[t];else this._currentFiles={...e};this._updateDirtyState(e)}_stopWatcher(){this._watcher&&(this._watcher.close(),this._watcher=void 0)}_setupWatcher(e){if(this._readyToWatch=!0,this._watcher||!this._watchContentFromWebContainer)return;const t=new Map;let s;const n=()=>{const i=[...t.entries()];t.clear(),Promise.all(i.map(async([a,f])=>{const h=await e.fs.readFile(a,f);return[a,h]})).then(a=>{for(const[f,h]of a)this._editorStore.updateFile(f,h)})},o=(i,a)=>{t.set(i,a),clearTimeout(s),s=setTimeout(n,100)};this._watcher=e.fs.watch(".",{recursive:!0},(i,a)=>{const f=`/${a}`;if(this._ignoreFileEvents.decrement(f)&&!(Array.isArray(this._watchContentFromWebContainer)&&!this._watchContentFromWebContainer.some(h=>Us.isMatch(f,h)))){if(i==="change"){const h=this._editorStore.documents.get()[f];if(!h)return;o(f,typeof h.value=="string"?"utf-8":null)}else if(i==="rename"&&Array.isArray(this._watchContentFromWebContainer))if(this._editorStore.documents.get()[f])this._editorStore.deleteFile(f);else{const p=f.split("/");p.forEach((m,S)=>{if(S==p.length-1)return;const T=p.slice(0,S+1).join("/");this._editorStore.documents.get()[T]||this._editorStore.addFileOrFolder({path:T,type:"folder"})}),this._editorStore.documents.get()[f]||this._editorStore.addFileOrFolder({path:f,type:"file"}),this._updateCurrentFiles({[f]:""}),o(f,"utf-8")}}})}_clearDirtyState(){this._packageJsonDirty=!1}_changeDetection(e){if(this._packageJsonDirty||!this._currentRunCommands)return!0;const t=rt(this._currentRunCommands),s=rt(e);if(t.length!==s.length)return!0;for(let n=0;n<t.length;++n)if(!le.equals(t[n],s[n]))return!0;return!1}}function rt(r){return r instanceof Ze?[...r].filter(e=>e.isRunnable()):rt(new Ze(r))}async function Xs(r,e,t){const{removed:s,addedOrModified:n}=Gs(e,t);for(const o of s)await r.fs.rm(o,{force:!0});await r.mount(tt(n))}class Ks{_webcontainer;_runner;_previewsStore;_editorStore;_terminalStore;_stepController=new qr;_lessonFilesFetcher;_lessonTask;_lesson;_ref=B(1);_themeRef=B(1);_lessonFiles;_lessonSolution;_lessonTemplate;lessonFullyLoaded=B(!1);constructor({useAuth:e,webcontainer:t,basePathname:s}){this._webcontainer=t,this._editorStore=new rs,this._lessonFilesFetcher=new Yr(s),this._previewsStore=new ss(this._webcontainer),this._terminalStore=new us(this._webcontainer,e),this._runner=new js(this._webcontainer,this._terminalStore,this._editorStore,this._stepController)}setLesson(e,t={}){e!==this._lesson&&(this._lessonTask?.cancel(),this._ref.set(1+(this._ref.value||0)),this._lesson=e,this.lessonFullyLoaded.set(!1),this._previewsStore.setPreviews(e.data.previews??!0),this._terminalStore.setTerminalConfiguration(e.data.terminal),this._editorStore.setEditorConfig(e.data.editor),this._runner.setCommands(e.data),this._editorStore.setDocuments(e.files),!t.ssr&&(this._runner.setWatchFromWebContainer(e.data.filesystem?.watch??!1),this._lessonTask=q(async s=>{const n=this._lessonFilesFetcher.getLessonTemplate(e),o=this._lessonFilesFetcher.getLessonFiles(e),i=this._runner.prepareFiles({template:n,files:o,signal:s});this._runner.runCommands();const[a,f,h]=await Promise.all([n,this._lessonFilesFetcher.getLessonSolution(e),o]);s.throwIfAborted(),this._lessonTemplate=a,this._lessonFiles=h,this._lessonSolution=f,this._editorStore.setDocuments(h),e.data.focus===void 0?this._editorStore.setSelectedFile(void 0):h[e.data.focus]!==void 0&&this._editorStore.setSelectedFile(e.data.focus),await i,s.throwIfAborted(),this.lessonFullyLoaded.set(!0)},{ignoreCancel:!0})))}get previews(){return this._previewsStore.previews}get terminalConfig(){return this._terminalStore.terminalConfig}get editorConfig(){return this._editorStore.editorConfig}get currentDocument(){return this._editorStore.currentDocument}get bootStatus(){return Xr}get documents(){return this._editorStore.documents}get files(){return this._editorStore.files}get selectedFile(){return this._editorStore.selectedFile}get lesson(){return this._lesson}get ref(){return this._ref}get themeRef(){return this._themeRef}get steps(){return this._stepController.steps}hasFileTree(){return this._lesson?this.editorConfig.get().fileTree.visible:!1}hasEditor(){return this._lesson?this.editorConfig.get().visible:!1}hasPreviews(){if(!this._lesson)return!1;const{previews:e}=this._lesson.data;return e!==!1}hasTerminalPanel(){return this._terminalStore.hasTerminalPanel()}hasSolution(){return!!this._lesson&&Object.keys(this._lesson.solution[1]).length>=1}unblockBoot(){Vr()}reset(){!this.lessonFullyLoaded.value||!this._lessonFiles||(this._editorStore.setDocuments(this._lessonFiles),this._runner.updateFiles(this._lessonFiles))}solve(){if(!this.lessonFullyLoaded.value||!this._lessonSolution)return;const t={...this._lessonFiles,...this._lessonSolution};this._editorStore.setDocuments(t),this._runner.updateFiles(t)}setSelectedFile(e){this._editorStore.setSelectedFile(e)}async addFile(e){if(this.setSelectedFile(e),!this._editorStore.files.get().find(t=>t.path===e)){if(await this._runner.fileExists(e))throw new Error("FILE_EXISTS");this._editorStore.addFileOrFolder({path:e,type:"file"}),this._runner.updateFile(e,"")}}async addFolder(e){if(!this._editorStore.files.get().some(t=>t.path.startsWith(e))){if(await this._runner.folderExists(e))throw new Error("FOLDER_EXISTS");this._editorStore.addFileOrFolder({path:e,type:"folder"}),this._runner.createFolder(e)}}updateFile(e,t){this._editorStore.updateFile(e,t)&&this._runner.updateFile(e,t)}setCurrentDocumentContent(e){const t=this.currentDocument.get()?.filePath;t&&this.updateFile(t,e)}setCurrentDocumentScrollPosition(e){const t=this.currentDocument.get();if(!t)return;const{filePath:s}=t;this._editorStore.updateScrollPosition(s,e)}attachTerminal(e,t){this._terminalStore.attachTerminal(e,t)}onTerminalResize(e,t){e&&t&&(this._terminalStore.onTerminalResize(e,t),this._runner.onTerminalResize(e,t))}onDocumentChanged(e,t){return this._editorStore.onDocumentChanged(e,t)}takeSnapshot(){return this._runner.takeSnapshot()}}function Vs(r,...e){let t=r||"/";for(const s of e){if(s.length===0)continue;const n=t.endsWith("/"),o=s.startsWith("/");n&&o?t+=s.slice(1):n||o?t+=s:t+=`/${s}`}return t}let st=new Promise(()=>{});st=Promise.resolve(null).then(()=>Kr({workdirName:"tutorial"})),st.then(()=>{Js.loaded=!0});const Zs=new Ks({webcontainer:st,useAuth:zt,basePathname:Vs("/anu/tutorial/","/")});async function en(){de.startAuthFlow({popup:!0}),await de.loggedIn()}function tn(){de.logout({ignoreRevokeError:!0})}const Js={useAuth:zt,loggedIn:()=>de.loggedIn(),loaded:!1};export{tn as a,en as l,Us as p,Zs as t,st as w};
